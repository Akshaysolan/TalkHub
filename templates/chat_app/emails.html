{% extends "chat_app/base.html" %}

{% block header_title %}Email System{% endblock %}

{% block header_subtitle %}Send and receive emails in real-time{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row">
        <!-- Email Sidebar (Left Side) -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="email-sidebar-container" style="background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 20px;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-envelope me-2"></i>Email Menu</h5>
                    <button class="btn btn-sm btn-primary" onclick="composeEmail()">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                
                <div class="list-group email-sidebar-menu">
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="loadEmailInbox()" id="inboxLink">
                        <div>
                            <i class="fas fa-inbox me-2"></i>Inbox
                        </div>
                        <span class="badge bg-danger rounded-pill" id="unreadCountSidebar">0</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="loadSentEmails()" id="sentLink">
                        <i class="fas fa-paper-plane me-2"></i>Sent
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="loadImportantEmails()" id="importantLink">
                        <i class="fas fa-star me-2"></i>Important
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="loadDraftEmails()" id="draftsLink">
                        <i class="fas fa-file-alt me-2"></i>Drafts
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="loadTrashEmails()" id="trashLink">
                        <i class="fas fa-trash me-2"></i>Trash
                    </a>
                </div>
                
                <div class="mt-4 pt-3 border-top">
                    <h6 class="mb-3">Email Stats</h6>
                    <div class="email-stats">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total:</span>
                            <span class="fw-bold" id="totalEmailsStat">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Unread:</span>
                            <span class="fw-bold text-warning" id="unreadEmailsStat">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Important:</span>
                            <span class="fw-bold text-success" id="importantEmailsStat">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-top">
                    <h6 class="mb-3">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="composeEmail()">
                            <i class="fas fa-edit me-2"></i>Compose
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="refreshEmails()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Timezone Display -->
                <div class="mt-4 pt-3 border-top">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-2 text-primary"></i>
                        <small class="text-muted" id="currentTimeIST">Loading IST time...</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Email Content (Right Side) -->
        <div class="col-lg-9 col-md-8">
            <!-- Real-time Status -->
            <div class="alert alert-info d-flex align-items-center mb-4">
                <i class="fas fa-sync-alt fa-spin me-2"></i>
                <div>
                    <strong>Real-time enabled</strong> - New emails will appear automatically
                    <small class="d-block text-muted">Last checked: <span id="lastChecked">Just now</span> (IST)</small>
                </div>
            </div>

            <!-- Email Container -->
            <div class="email-container">
                <div class="email-header p-3 border-bottom">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0" id="currentFolderTitle">Inbox</h5>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshEmails()" title="Refresh">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="markAsRead()" title="Mark as read">
                                    <i class="fas fa-envelope-open"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="markAsImportant()" title="Mark as important">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSelected()" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="email-list" id="emailList">
                    <!-- Emails will be loaded here via JavaScript -->
                    <div class="text-center py-5">
                        <i class="fas fa-envelope fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Loading emails...</h5>
                        <p class="text-muted">Please wait while we fetch your emails</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Email System with IST Timezone -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadEmailInbox();
        startRealTimeEmailCheck();
        updateISTTime(); // Initialize IST time display
        setInterval(updateISTTime, 1000); // Update IST time every second
    });

    let selectedEmails = new Set();
    let currentFilter = 'inbox';
    let currentFolderTitle = 'Inbox';

    // IST Timezone functions
    function getCurrentISTTime() {
        const now = new Date();
        
        // Convert to IST (UTC+5:30)
        const istOffset = 5.5 * 60 * 60 * 1000; // 5.5 hours in milliseconds
        const istTime = new Date(now.getTime() + istOffset);
        
        // For server-side times, we need to adjust from UTC to IST
        // Assuming server sends UTC time
        return istTime;
    }

    function formatISTTime(date) {
        const options = {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        };
        return date.toLocaleTimeString('en-IN', options) + ' IST';
    }

    function formatISTDateTime(date) {
        const options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        };
        return date.toLocaleDateString('en-IN', options) + ' IST';
    }

    function updateISTTime() {
        const istTime = getCurrentISTTime();
        const formattedTime = formatISTTime(istTime);
        document.getElementById('currentTimeIST').textContent = formattedTime;
    }

    function convertToIST(serverTime) {
        // If serverTime is already a string, parse it
        let date;
        if (typeof serverTime === 'string') {
            date = new Date(serverTime);
        } else if (serverTime instanceof Date) {
            date = serverTime;
        } else {
            return 'Just now';
        }
        
        // Check if date is valid
        if (isNaN(date.getTime())) {
            return 'Invalid date';
        }
        
        // Convert to IST (UTC+5:30)
        const istOffset = 5.5 * 60 * 60 * 1000;
        const istTime = new Date(date.getTime() + istOffset);
        
        const now = getCurrentISTTime();
        const diffMs = now - istTime;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / (3600000 * 24));
        
        // Format based on time difference
        if (diffMins < 1) {
            return 'Just now';
        } else if (diffMins < 60) {
            return `${diffMins} min${diffMins !== 1 ? 's' : ''} ago`;
        } else if (diffHours < 24) {
            return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
        } else if (diffDays < 7) {
            return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
        } else {
            // For older dates, show full date
            return istTime.toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }
    }

    function formatTimeForDisplay(dateString) {
        if (!dateString) return '';
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            
            // Convert to IST
            const istOffset = 5.5 * 60 * 60 * 1000;
            const istTime = new Date(date.getTime() + istOffset);
            
            const now = getCurrentISTTime();
            const diffMs = now - istTime;
            const diffDays = Math.floor(diffMs / (3600000 * 24));
            
            if (diffDays === 0) {
                // Today - show time only
                return istTime.toLocaleTimeString('en-IN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            } else if (diffDays === 1) {
                // Yesterday
                return 'Yesterday';
            } else if (diffDays < 7) {
                // Within a week - show day name
                return istTime.toLocaleDateString('en-IN', { weekday: 'short' });
            } else {
                // Older - show date
                return istTime.toLocaleDateString('en-IN', {
                    day: 'numeric',
                    month: 'short'
                });
            }
        } catch (e) {
            console.error('Error formatting time:', e);
            return dateString;
        }
    }

    function loadEmailInbox() {
        currentFilter = 'inbox';
        currentFolderTitle = 'Inbox';
        updateLastChecked();
        updateSidebarActive('inbox');
        updateFolderTitle();
        fetch('/api/emails/inbox/?filter=inbox')
            .then(response => response.json())
            .then(data => {
                // Process times for IST display
                data.emails.forEach(email => {
                    email.displayTime = formatTimeForDisplay(email.time);
                    email.fullDateIST = formatISTDateTime(new Date(email.time || new Date()));
                });
                renderEmailList(data.emails);
                updateEmailStats(data);
            })
            .catch(error => {
                console.error('Error loading inbox emails:', error);
                showEmailError('Failed to load inbox. Please try again.');
            });
    }

    function loadSentEmails() {
        currentFilter = 'sent';
        currentFolderTitle = 'Sent Emails';
        updateSidebarActive('sent');
        updateFolderTitle();
        fetch('/api/emails/inbox/?filter=sent')
            .then(response => response.json())
            .then(data => {
                data.emails.forEach(email => {
                    email.displayTime = formatTimeForDisplay(email.time);
                    email.fullDateIST = formatISTDateTime(new Date(email.time || new Date()));
                });
                renderEmailList(data.emails);
                updateEmailStats(data);
            })
            .catch(error => {
                console.error('Error loading sent emails:', error);
                showEmailError('Failed to load sent emails. Please try again.');
            });
    }

    function loadImportantEmails() {
        currentFilter = 'important';
        currentFolderTitle = 'Important Emails';
        updateSidebarActive('important');
        updateFolderTitle();
        fetch('/api/emails/inbox/?filter=important')
            .then(response => response.json())
            .then(data => {
                data.emails.forEach(email => {
                    email.displayTime = formatTimeForDisplay(email.time);
                    email.fullDateIST = formatISTDateTime(new Date(email.time || new Date()));
                });
                renderEmailList(data.emails);
                updateEmailStats(data);
            })
            .catch(error => {
                console.error('Error loading important emails:', error);
                showEmailError('Failed to load important emails. Please try again.');
            });
    }

    function loadDraftEmails() {
        currentFilter = 'drafts';
        currentFolderTitle = 'Drafts';
        updateSidebarActive('drafts');
        updateFolderTitle();
        fetch('/api/emails/inbox/?filter=drafts')
            .then(response => response.json())
            .then(data => {
                data.emails.forEach(email => {
                    email.displayTime = formatTimeForDisplay(email.time);
                    email.fullDateIST = formatISTDateTime(new Date(email.time || new Date()));
                });
                renderEmailList(data.emails);
                updateEmailStats(data);
            })
            .catch(error => {
                console.error('Error loading draft emails:', error);
                showEmailError('Failed to load drafts. Please try again.');
            });
    }

    function loadTrashEmails() {
        currentFilter = 'trash';
        currentFolderTitle = 'Trash';
        updateSidebarActive('trash');
        updateFolderTitle();
        fetch('/api/emails/inbox/?filter=trash')
            .then(response => response.json())
            .then(data => {
                data.emails.forEach(email => {
                    email.displayTime = formatTimeForDisplay(email.time);
                    email.fullDateIST = formatISTDateTime(new Date(email.time || new Date()));
                });
                renderEmailList(data.emails);
                updateEmailStats(data);
            })
            .catch(error => {
                console.error('Error loading trash emails:', error);
                showEmailError('Failed to load trash. Please try again.');
            });
    }

    function updateSidebarActive(filter) {
        // Remove active class from all sidebar items
        document.querySelectorAll('.email-sidebar-menu .list-group-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Add active class to current filter
        const activeItem = document.getElementById(filter + 'Link');
        if (activeItem) {
            activeItem.classList.add('active');
        }
    }

    function updateFolderTitle() {
        document.getElementById('currentFolderTitle').textContent = currentFolderTitle;
    }

    function renderEmailList(emails) {
        const emailList = document.getElementById('emailList');
        if (!emails || emails.length === 0) {
            emailList.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No emails found</h5>
                    <p class="text-muted">Your ${currentFolderTitle.toLowerCase()} is empty</p>
                    ${currentFilter === 'drafts' ? 
                        `<button class="btn btn-primary mt-2" onclick="composeEmail()">
                            <i class="fas fa-edit me-2"></i>Create New Draft
                        </button>` : 
                        currentFilter === 'trash' ? 
                        `<button class="btn btn-secondary mt-2" onclick="emptyTrash()">
                            <i class="fas fa-trash-alt me-2"></i>Empty Trash
                        </button>` :
                        `<button class="btn btn-primary mt-2" onclick="composeEmail()">
                            <i class="fas fa-edit me-2"></i>Compose New Email
                        </button>`
                    }
                </div>
            `;
            return;
        }

        emailList.innerHTML = emails.map(email => `
            <div class="email-list-item ${email.unread ? 'unread' : ''} ${email.important ? 'important' : ''}" 
                 onclick="viewEmail(${email.id})">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="form-check">
                            <input class="form-check-input email-checkbox" type="checkbox" 
                                   data-email-id="${email.id}" 
                                   onchange="toggleEmailSelection(${email.id})"
                                   ${selectedEmails.has(email.id) ? 'checked' : ''}
                                   onclick="event.stopPropagation()">
                        </div>
                    </div>
                    <div class="me-3">
                        <div class="email-avatar ${currentFilter === 'sent' ? 'bg-info' : 'bg-primary'}">
                            ${currentFilter === 'sent' ? 
                                '<i class="fas fa-paper-plane text-white"></i>' : 
                                email.sender ? email.sender.charAt(0).toUpperCase() : '?'}
                        </div>
                    </div>
                    <div class="email-preview flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <div class="email-subject">
                                ${email.important ? '<i class="fas fa-star text-warning me-1"></i>' : ''}
                                ${currentFilter === 'sent' ? 
                                    `<strong>To:</strong> ${email.recipient || 'Multiple recipients'}` : 
                                    email.unread ? '<strong>' + email.subject + '</strong>' : email.subject}
                            </div>
                            <div class="email-time" title="${email.fullDateIST || email.time}">
                                ${email.displayTime || email.time}
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="email-preview-text">
                                ${currentFilter === 'sent' ? 
                                    email.subject : 
                                    (email.sender ? `<strong>${email.sender}:</strong> ` : '') + email.preview}
                            </div>
                            ${email.attachments > 0 ? 
                                `<span class="badge bg-secondary ms-2">
                                    <i class="fas fa-paperclip"></i> ${email.attachments}
                                </span>` : ''
                            }
                            ${currentFilter === 'drafts' ? 
                                `<span class="badge bg-warning ms-2">
                                    <i class="fas fa-save"></i> Draft
                                </span>` : ''
                            }
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function updateEmailStats(data) {
        // Update sidebar stats
        document.getElementById('totalEmailsStat').textContent = data.total_count || data.emails.length;
        document.getElementById('unreadEmailsStat').textContent = data.unread_count || 0;
        document.getElementById('unreadCountSidebar').textContent = data.unread_count || 0;
        
        // Hide badge if no unread emails
        const unreadBadge = document.getElementById('unreadCountSidebar');
        unreadBadge.style.display = (data.unread_count > 0) ? 'block' : 'none';
        
        // Update important count
        let importantCount = 0;
        if (data.emails) {
            importantCount = data.emails.filter(email => email.important).length;
        }
        document.getElementById('importantEmailsStat').textContent = importantCount;
    }

    function composeEmail() {
        window.location.href = "{% url 'chat_app:email_compose' %}";
    }

    function viewEmail(emailId) {
        // Check if this is a draft
        if (currentFilter === 'drafts') {
            window.location.href = `{% url 'chat_app:email_compose' %}?draft_id=${emailId}`;
            return;
        }
        
        showEmailDetail(emailId);
    }

    function showEmailDetail(emailId) {
        fetch(`/api/emails/${emailId}/`)
            .then(response => response.json())
            .then(data => {
                // Convert date to IST
                let fullDateIST = data.full_date;
                try {
                    const date = new Date(data.full_date || data.time || new Date());
                    if (!isNaN(date.getTime())) {
                        fullDateIST = formatISTDateTime(date);
                    }
                } catch (e) {
                    console.error('Error converting date to IST:', e);
                }
                
                const modalHTML = `
                    <div class="modal fade" id="emailDetailModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">${data.subject || '(No Subject)'}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="email-detail-header mb-4">
                                        <div class="d-flex justify-content-between mb-2">
                                            <strong>From:</strong> ${data.sender || data.sender_email}
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <strong>To:</strong> ${data.recipient || data.recipients}
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <strong>Date:</strong> ${fullDateIST}
                                        </div>
                                    </div>
                                    <div class="email-body mb-4">
                                        ${data.body_html || data.body}
                                    </div>
                                    ${data.attachments && data.attachments.length > 0 ? `
                                        <div class="email-attachments">
                                            <h6>Attachments (${data.attachments.length})</h6>
                                            <div class="list-group">
                                                ${data.attachments.map(att => `
                                                    <a href="${att.url}" class="list-group-item list-group-item-action" download="${att.name}">
                                                        <i class="fas fa-paperclip me-2"></i>
                                                        ${att.name} (${att.size})
                                                    </a>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    ${data.can_reply ? `<button type="button" class="btn btn-primary" onclick="replyToEmail(${emailId})">Reply</button>` : ''}
                                    <button type="button" class="btn btn-outline-primary" onclick="forwardEmail(${emailId})">Forward</button>
                                    <button type="button" class="btn btn-outline-danger" onclick="deleteSingleEmail(${emailId})">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const modalDiv = document.createElement('div');
                modalDiv.innerHTML = modalHTML;
                document.body.appendChild(modalDiv);
                
                const modal = new bootstrap.Modal(document.getElementById('emailDetailModal'));
                modal.show();
                
                document.getElementById('emailDetailModal').addEventListener('hidden.bs.modal', function() {
                    modalDiv.remove();
                });
                
            })
            .catch(error => {
                console.error('Error loading email detail:', error);
                showNotification('Failed to load email details', 'error');
            });
    }

    function replyToEmail(emailId) {
        window.location.href = `{% url 'chat_app:email_compose' %}?reply_to=${emailId}`;
    }

    function forwardEmail(emailId) {
        window.location.href = `{% url 'chat_app:email_compose' %}?forward=${emailId}`;
    }

    function deleteSingleEmail(emailId) {
        if (confirm('Are you sure you want to delete this email?')) {
            fetch(`/api/emails/${emailId}/delete/`, { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ permanent: currentFilter === 'trash' })
            })
            .then(response => response.json())
            .then(data => {
                showNotification(data.message, 'success');
                refreshCurrentFolder();
            })
            .catch(error => {
                console.error('Error deleting email:', error);
                showNotification('Failed to delete email', 'error');
            });
        }
    }

    function emptyTrash() {
        if (confirm('Are you sure you want to permanently delete all emails in trash? This action cannot be undone.')) {
            fetch('/api/emails/bulk_action/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email_ids: Array.from(selectedEmails),
                    action: 'delete'
                })
            })
            .then(response => response.json())
            .then(data => {
                showNotification(data.message, 'success');
                loadTrashEmails();
                selectedEmails.clear();
            })
            .catch(error => {
                console.error('Error emptying trash:', error);
                showNotification('Failed to empty trash', 'error');
            });
        }
    }

    function toggleEmailSelection(emailId) {
        if (selectedEmails.has(emailId)) {
            selectedEmails.delete(emailId);
        } else {
            selectedEmails.add(emailId);
        }
        updateSelectAllCheckbox();
    }

    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.email-checkbox');
        const selectAll = document.getElementById('selectAll').checked;
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll;
            const emailId = parseInt(checkbox.getAttribute('data-email-id'));
            if (selectAll) {
                selectedEmails.add(emailId);
            } else {
                selectedEmails.delete(emailId);
            }
        });
    }

    function updateSelectAllCheckbox() {
        const checkboxes = document.querySelectorAll('.email-checkbox');
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        document.getElementById('selectAll').checked = allChecked;
    }

    function refreshEmails() {
        refreshCurrentFolder();
        showNotification('Refreshing emails...', 'info');
    }

    function refreshCurrentFolder() {
        switch(currentFilter) {
            case 'sent':
                loadSentEmails();
                break;
            case 'important':
                loadImportantEmails();
                break;
            case 'drafts':
                loadDraftEmails();
                break;
            case 'trash':
                loadTrashEmails();
                break;
            default:
                loadEmailInbox();
        }
    }

    function markAsRead() {
        if (selectedEmails.size === 0) {
            showNotification('Please select emails first', 'warning');
            return;
        }
        
        fetch('/api/emails/bulk_action/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email_ids: Array.from(selectedEmails),
                action: 'read'
            })
        })
        .then(response => response.json())
        .then(data => {
            showNotification(data.message, 'success');
            selectedEmails.clear();
            refreshCurrentFolder();
        })
        .catch(error => {
            console.error('Error marking emails as read:', error);
            showNotification('Failed to mark emails as read', 'error');
        });
    }

    function markAsImportant() {
        if (selectedEmails.size === 0) {
            showNotification('Please select emails first', 'warning');
            return;
        }
        
        fetch('/api/emails/bulk_action/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email_ids: Array.from(selectedEmails),
                action: 'star'
            })
        })
        .then(response => response.json())
        .then(data => {
            showNotification(data.message, 'success');
            selectedEmails.clear();
            refreshCurrentFolder();
        })
        .catch(error => {
            console.error('Error marking emails as important:', error);
            showNotification('Failed to mark emails as important', 'error');
        });
    }

    function deleteSelected() {
        if (selectedEmails.size === 0) {
            showNotification('Please select emails first', 'warning');
            return;
        }
        
        const action = currentFilter === 'trash' ? 'delete' : 'trash';
        const message = currentFilter === 'trash' ? 
            `Are you sure you want to permanently delete ${selectedEmails.size} email(s)?` :
            `Are you sure you want to move ${selectedEmails.size} email(s) to trash?`;
        
        if (confirm(message)) {
            fetch('/api/emails/bulk_action/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email_ids: Array.from(selectedEmails),
                    action: action
                })
            })
            .then(response => response.json())
            .then(data => {
                showNotification(data.message, 'success');
                selectedEmails.clear();
                refreshCurrentFolder();
            })
            .catch(error => {
                console.error('Error deleting emails:', error);
                showNotification('Failed to delete emails', 'error');
            });
        }
    }

    function startRealTimeEmailCheck() {
        setInterval(() => {
            checkForNewEmails();
        }, 30000);
    }

    function checkForNewEmails() {
        fetch('/api/emails/check_new/')
            .then(response => response.json())
            .then(data => {
                updateLastChecked();
                if (data.has_new && currentFilter === 'inbox') {
                    showNotification(data.message, 'info');
                    loadEmailInbox();
                }
            })
            .catch(error => console.error('Error checking for new emails:', error));
    }

    function updateLastChecked() {
        const istTime = getCurrentISTTime();
        const timeString = formatISTTime(istTime);
        document.getElementById('lastChecked').textContent = timeString;
    }

    function showEmailError(message) {
        const emailList = document.getElementById('emailList');
        emailList.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5 class="text-danger">Error Loading Emails</h5>
                <p class="text-muted">${message}</p>
                <button class="btn btn-primary mt-2" onclick="refreshCurrentFolder()">
                    <i class="fas fa-sync-alt me-2"></i>Try Again
                </button>
            </div>
        `;
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 
                              type === 'warning' ? 'exclamation-triangle' : 
                              type === 'error' ? 'times-circle' : 'info-circle'} me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
</script>

<style>
    .email-sidebar-container {
        position: sticky;
        top: 20px;
    }
    
    .email-sidebar-menu .list-group-item {
        border: none;
        border-radius: 8px;
        margin-bottom: 5px;
        transition: var(--transition);
        cursor: pointer;
    }
    
    .email-sidebar-menu .list-group-item:hover {
        background-color: rgba(102, 126, 234, 0.1);
        transform: translateX(5px);
    }
    
    .email-sidebar-menu .list-group-item.active {
        background: var(--primary-gradient);
        color: white;
        border: none;
    }
    
    .email-list-item {
        padding: 15px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        cursor: pointer;
        transition: var(--transition);
    }
    
    .email-list-item:last-child {
        border-bottom: none;
    }
    
    .email-list-item.unread {
        background-color: rgba(102, 126, 234, 0.05);
    }
    
    .email-list-item.important {
        border-left: 4px solid #ffc107;
    }
    
    .email-list-item:hover {
        background-color: rgba(102, 126, 234, 0.1);
    }
    
    .email-checkbox {
        margin: 0;
    }
    
    .email-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-gradient);
        color: white;
        font-weight: bold;
    }
    
    .email-header {
        background: rgba(0,0,0,0.02);
    }
    
    .email-stats {
        font-size: 0.9rem;
    }
    
    .email-preview-text {
        color: #666;
        font-size: 0.9rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 500px;
    }
    
    .email-time {
        color: #999;
        font-size: 0.85rem;
        white-space: nowrap;
        cursor: help;
    }
    
    .email-subject {
        font-weight: 500;
        color: #333;
    }
    
    [data-theme="dark"] .email-sidebar-container,
    [data-theme="dark"] .email-container {
        background: #1e1e1e;
    }
    
    [data-theme="dark"] .email-header {
        background: rgba(255,255,255,0.05);
    }
    
    [data-theme="dark"] .email-sidebar-menu .list-group-item {
        background-color: #2d2d2d;
        color: var(--text-light);
    }
    
    [data-theme="dark"] .email-sidebar-menu .list-group-item:hover {
        background-color: #3d3d3d;
    }
    
    [data-theme="dark"] .email-sidebar-menu .list-group-item.active {
        background: var(--primary-gradient);
    }
    
    [data-theme="dark"] .email-list-item {
        border-bottom-color: rgba(255,255,255,0.1);
    }
    
    [data-theme="dark"] .email-list-item.unread {
        background-color: rgba(102, 126, 234, 0.1);
    }
    
    [data-theme="dark"] .email-preview-text,
    [data-theme="dark"] .email-subject {
        color: #ddd;
    }
    
    [data-theme="dark"] .email-time {
        color: #aaa;
    }
    
    [data-theme="dark"] .email-stats {
        color: #ddd;
    }
</style>
{% endblock %}