{% extends "chat_app/base.html" %}

{% block header_title %}Email System{% endblock %}

{% block header_subtitle %}Send and receive emails in real-time{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row">
        <!-- Email Sidebar (Left Side) -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="email-sidebar-container" style="background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 20px;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-envelope me-2"></i>Email Menu</h5>
                    <button class="btn btn-sm btn-primary" onclick="composeEmail()">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                
                <div class="list-group email-sidebar-menu">
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center active" onclick="loadEmailInbox()">
                        <div>
                            <i class="fas fa-inbox me-2"></i>Inbox
                        </div>
                        <span class="badge bg-danger rounded-pill" id="unreadCountSidebar">0</span>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="loadSentEmails()">
                        <i class="fas fa-paper-plane me-2"></i>Sent
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="loadImportantEmails()">
                        <i class="fas fa-star me-2"></i>Important
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="loadDraftEmails()">
                        <i class="fas fa-file-alt me-2"></i>Drafts
                    </a>
                    <a href="#" class="list-group-item list-group-item-action" onclick="loadTrashEmails()">
                        <i class="fas fa-trash me-2"></i>Trash
                    </a>
                </div>
                
                <div class="mt-4 pt-3 border-top">
                    <h6 class="mb-3">Email Stats</h6>
                    <div class="email-stats">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total:</span>
                            <span class="fw-bold" id="totalEmailsStat">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Unread:</span>
                            <span class="fw-bold text-warning" id="unreadEmailsStat">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Important:</span>
                            <span class="fw-bold text-success" id="importantEmailsStat">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-top">
                    <h6 class="mb-3">Quick Actions</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="composeEmail()">
                            <i class="fas fa-edit me-2"></i>Compose
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="refreshEmails()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Email Content (Right Side) -->
        <div class="col-lg-9 col-md-8">
            <!-- Real-time Status -->
            <div class="alert alert-info d-flex align-items-center mb-4">
                <i class="fas fa-sync-alt fa-spin me-2"></i>
                <div>
                    <strong>Real-time enabled</strong> - New emails will appear automatically
                    <small class="d-block text-muted">Last checked: <span id="lastChecked">Just now</span></small>
                </div>
            </div>

            <!-- Email Container -->
            <div class="email-container">
                <div class="email-header p-3 border-bottom">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                <label class="form-check-label" for="selectAll">Select All</label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshEmails()" title="Refresh">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="markAsRead()" title="Mark as read">
                                    <i class="fas fa-envelope-open"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="markAsImportant()" title="Mark as important">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSelected()" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="email-list" id="emailList">
                    <!-- Emails will be loaded here via JavaScript -->
                    <div class="text-center py-5">
                        <i class="fas fa-envelope fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Loading emails...</h5>
                        <p class="text-muted">Please wait while we fetch your emails</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Email System -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadEmailInbox();
        startRealTimeEmailCheck();
    });

    let selectedEmails = new Set();
    let currentFilter = 'inbox';

    function loadEmailInbox() {
        currentFilter = 'inbox';
        updateLastChecked();
        updateSidebarActive('inbox');
        fetch('/api/emails/inbox/')
            .then(response => response.json())
            .then(data => {
                renderEmailList(data.emails);
                updateEmailStats(data);
            })
            .catch(error => {
                console.error('Error loading emails:', error);
                showEmailError('Failed to load emails. Please try again.');
            });
    }

    function loadSentEmails() {
        currentFilter = 'sent';
        updateSidebarActive('sent');
        // For now, load inbox as placeholder
        loadEmailInbox();
        showNotification('Sent emails would load here', 'info');
    }

    function loadImportantEmails() {
        currentFilter = 'important';
        updateSidebarActive('important');
        // For now, load inbox as placeholder
        loadEmailInbox();
        showNotification('Important emails would load here', 'info');
    }

    function loadDraftEmails() {
        currentFilter = 'drafts';
        updateSidebarActive('drafts');
        // For now, load inbox as placeholder
        loadEmailInbox();
        showNotification('Draft emails would load here', 'info');
    }

    function loadTrashEmails() {
        currentFilter = 'trash';
        updateSidebarActive('trash');
        // For now, load inbox as placeholder
        loadEmailInbox();
        showNotification('Trash emails would load here', 'info');
    }

    function updateSidebarActive(filter) {
        // Remove active class from all sidebar items
        document.querySelectorAll('.email-sidebar-menu .list-group-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Add active class to current filter
        const activeItem = document.querySelector(`.email-sidebar-menu a[onclick*="${filter}"]`);
        if (activeItem) {
            activeItem.classList.add('active');
        }
    }

    function renderEmailList(emails) {
        const emailList = document.getElementById('emailList');
        if (!emails || emails.length === 0) {
            emailList.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No emails found</h5>
                    <p class="text-muted">Your ${currentFilter} is empty</p>
                    <button class="btn btn-primary mt-2" onclick="composeEmail()">
                        <i class="fas fa-edit me-2"></i>Compose New Email
                    </button>
                </div>
            `;
            return;
        }

        emailList.innerHTML = emails.map(email => `
            <div class="email-list-item ${email.unread ? 'unread' : ''} ${email.important ? 'important' : ''}" 
                 onclick="viewEmail(${email.id})">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="form-check">
                            <input class="form-check-input email-checkbox" type="checkbox" 
                                   data-email-id="${email.id}" 
                                   onchange="toggleEmailSelection(${email.id})"
                                   ${selectedEmails.has(email.id) ? 'checked' : ''}
                                   onclick="event.stopPropagation()">
                        </div>
                    </div>
                    <div class="me-3">
                        <div class="email-avatar">${email.sender.charAt(0).toUpperCase()}</div>
                    </div>
                    <div class="email-preview flex-grow-1">
                        <div class="d-flex justify-content-between">
                            <div class="email-subject">
                                ${email.important ? '<i class="fas fa-star text-warning me-1"></i>' : ''}
                                ${email.unread ? '<strong>' + email.subject + '</strong>' : email.subject}
                            </div>
                            <div class="email-time">${email.time}</div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="email-preview-text">${email.preview}</div>
                            ${email.attachments > 0 ? 
                                `<span class="badge bg-secondary ms-2">
                                    <i class="fas fa-paperclip"></i> ${email.attachments}
                                </span>` : ''
                            }
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function updateEmailStats(data) {
        // Update sidebar stats
        document.getElementById('totalEmailsStat').textContent = data.emails.length;
        document.getElementById('unreadEmailsStat').textContent = data.unread_count;
        document.getElementById('unreadCountSidebar').textContent = data.unread_count;
        
        // Hide badge if no unread emails
        const unreadBadge = document.getElementById('unreadCountSidebar');
        unreadBadge.style.display = data.unread_count > 0 ? 'block' : 'none';
        
        // For now, use placeholder for important count
        document.getElementById('importantEmailsStat').textContent = Math.floor(data.emails.length / 3);
    }

    function composeEmail() {
        window.location.href = "{% url 'chat_app:email_compose' %}";
    }

    function viewEmail(emailId) {
        // For now, just show a notification
        showNotification(`Viewing email #${emailId} - In a real system, this would open the email`, 'info');
        
        // Mark as read
        fetch(`/api/emails/${emailId}/read/`, { method: 'POST' })
            .then(() => loadEmailInbox());
    }

    function toggleEmailSelection(emailId) {
        if (selectedEmails.has(emailId)) {
            selectedEmails.delete(emailId);
        } else {
            selectedEmails.add(emailId);
        }
        updateSelectAllCheckbox();
    }

    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.email-checkbox');
        const selectAll = document.getElementById('selectAll').checked;
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll;
            const emailId = parseInt(checkbox.getAttribute('data-email-id'));
            if (selectAll) {
                selectedEmails.add(emailId);
            } else {
                selectedEmails.delete(emailId);
            }
        });
    }

    function updateSelectAllCheckbox() {
        const checkboxes = document.querySelectorAll('.email-checkbox');
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        document.getElementById('selectAll').checked = allChecked;
    }

    function refreshEmails() {
        loadEmailInbox();
        showNotification('Refreshing emails...', 'info');
    }

    function markAsRead() {
        if (selectedEmails.size === 0) {
            showNotification('Please select emails first', 'warning');
            return;
        }
        
        selectedEmails.forEach(emailId => {
            fetch(`/api/emails/${emailId}/read/`, { method: 'POST' });
        });
        
        showNotification(`Marked ${selectedEmails.size} emails as read`, 'success');
        selectedEmails.clear();
        setTimeout(() => loadEmailInbox(), 1000);
    }

    function markAsImportant() {
        if (selectedEmails.size === 0) {
            showNotification('Please select emails first', 'warning');
            return;
        }
        showNotification(`Marked ${selectedEmails.size} emails as important`, 'success');
        selectedEmails.clear();
        setTimeout(() => loadEmailInbox(), 1000);
    }

    function deleteSelected() {
        if (selectedEmails.size === 0) {
            showNotification('Please select emails first', 'warning');
            return;
        }
        
        if (confirm(`Are you sure you want to delete ${selectedEmails.size} email(s)?`)) {
            selectedEmails.forEach(emailId => {
                fetch(`/api/emails/${emailId}/delete/`, { method: 'POST' });
            });
            
            showNotification(`Deleted ${selectedEmails.size} emails`, 'success');
            selectedEmails.clear();
            setTimeout(() => loadEmailInbox(), 1000);
        }
    }

    function startRealTimeEmailCheck() {
        // Check for new emails every 30 seconds
        setInterval(() => {
            updateLastChecked();
        }, 30000);
    }

    function updateLastChecked() {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        document.getElementById('lastChecked').textContent = timeString;
    }

    function showEmailError(message) {
        const emailList = document.getElementById('emailList');
        emailList.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5 class="text-danger">Error Loading Emails</h5>
                <p class="text-muted">${message}</p>
                <button class="btn btn-primary mt-2" onclick="loadEmailInbox()">
                    <i class="fas fa-sync-alt me-2"></i>Try Again
                </button>
            </div>
        `;
    }

    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
</script>

<style>
    .email-sidebar-container {
        position: sticky;
        top: 20px;
    }
    
    .email-sidebar-menu .list-group-item {
        border: none;
        border-radius: 8px;
        margin-bottom: 5px;
        transition: var(--transition);
    }
    
    .email-sidebar-menu .list-group-item:hover {
        background-color: rgba(102, 126, 234, 0.1);
        transform: translateX(5px);
    }
    
    .email-sidebar-menu .list-group-item.active {
        background: var(--primary-gradient);
        color: white;
        border: none;
    }
    
    .email-list-item.important {
        border-left: 4px solid #ffc107;
    }
    
    .email-list-item:hover {
        background: rgba(102, 126, 234, 0.05);
    }
    
    .email-checkbox {
        margin: 0;
    }
    
    .email-header {
        background: rgba(0,0,0,0.02);
    }
    
    .email-stats {
        font-size: 0.9rem;
    }
    
    [data-theme="dark"] .email-sidebar-container,
    [data-theme="dark"] .email-container {
        background: #1e1e1e;
    }
    
    [data-theme="dark"] .email-header {
        background: rgba(255,255,255,0.05);
    }
    
    [data-theme="dark"] .email-sidebar-menu .list-group-item {
        background-color: #2d2d2d;
        color: var(--text-light);
    }
    
    [data-theme="dark"] .email-sidebar-menu .list-group-item:hover {
        background-color: #3d3d3d;
    }
</style>
{% endblock %}